name: Lint

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'

permissions:
  contents: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run ktlintFormat
        run: ./gradlew ktlintFormat

      - name: Commit and push ktlint changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          if [ -n "$(git status --porcelain)" ]; then
            echo "Formatting issues found — committing fixes..."
            git add .
            git commit -m "chore: apply ktlint format via CI"

            if [ -n "${{ github.head_ref }}" ]; then
              echo "PR branch detected — skipping push"
            else
              echo "Pushing fixes to branch: ${{ github.ref_name }}"
              git push origin HEAD:${{ github.ref_name }}
            fi
          else
            echo "No formatting changes to commit."

      - name: Run ktlintCheck
        run: ./gradlew ktlintCheck